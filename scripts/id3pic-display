#!/bin/bash
# Displays pictures in the given mp3 file.

SCRSIZE=`xwininfo -metric -root | grep -m1 "Height:" | awk '{ print $2; }'`
[ $SCRSIZE -gt 0 ] || SCRSIZE=768

MAXSIZE=96

PREFIX=/tmp/.dispinfo
PIDFILE=$PREFIX-pid
PICPREF=$PREFIX-pic
PICMASK=$PICPREF*

USEREMOTE=

if [ -z "$DPROG" ]; then
    if [ -x "`which imlib2_view`" ]; then
	DPROG='imlib2_view'
    else
	DPROG='display -immutable'
    fi
fi

{
    rm -f $PICMASK
    [ x"$1" != x ] && id3pic -p $PICPREF "$1"
    IMGS=`ls $PICMASK | wc -l`

    DISP=`cat $PIDFILE`

    if [ $IMGS -gt 0 ]; then
	let SIZE='(SCRSIZE - 1)/IMGS + 1';
	[ $SIZE -gt $MAXSIZE ] && SIZE=$MAXSIZE;
	SIZE=$SIZE'x'$SIZE;
	montage -geometry $SIZE -tile 1x$IMGS -background "rgba(0,0,0,255)" \
	    $PICMASK $PICPREF.jpg
	if [ $DISP -gt 0 ] && kill -s 0 $DISP; then
	    if [ x$USEREMOTE != xyes ]; then
		kill $DISP
	    else
		EXISTING=-remote
	    fi
	fi
	$DPROG $EXISTING $PICPREF.jpg &
	[ x$EXISTING != x-remote ] && echo $! > $PIDFILE
    else
	[ $DISP -gt 0 ] && kill $DISP
	rm -f $PIDFILE
    fi
} 2> /dev/null
